@{
  ViewBag.Title = "Index";
}

<h2>Customers</h2>

<div class="input-form" data-ng-app="customerApp" data-ng-controller="customerCtrl">
  <form class="form-inline" role="form">
    <div class="form-group">
      <label>Search:</label>
      <input type="text" data-ng-model="customerFilter" class="form-control" />
    </div>
    <div class="form-group">
      <div class="input-group">
        <span data-ng-show="customerFilter.length > 0" class="btn" data-ng-click="resetSearch()"><i class="glyphicon glyphicon-remove"></i></span>
      </div>
    </div>
  </form>

  <hr />
  <div class="row">
    <div class="col-md-3">

      <label>Name</label>
      <input type="text" class="form-control" data-ng-model="customer.Name" placeholder="Enter customer name.." />
    </div>
  </div>
  <div class="row">
    <div class="col-md-1">
      <label>Type</label>
      <input type="text" class="form-control" data-ng-model="customer.CustomerType" placeholder="" />
    </div>
  </div>
  <div class="row">
    <div class="col-md-2">
      <label>Valid From</label>

      <p class="input-group">
        <input type="text" class="form-control"
          data-datepicker-popup="{{format}}"
          data-ng-model="customer.ValidFrom"
          data-is-open="fromOpened"
          data-min-date="minDate"
          data-datepicker-options="dateOptions"
          data-date-disabled="disabled(date, mode)"
          data-ng-required="true"
          data-close-text="Close" />
        <span class="input-group-btn">
          <button type="button" class="btn btn-default" data-ng-click="fromOpen($event)"><i class="glyphicon glyphicon-calendar"></i></button>
        </span>
      </p>
    </div>

    <div class="col-md-2">
      <label>Valid To</label>
       <p class="input-group">
        <input type="text" class="form-control"
          data-datepicker-popup="{{format}}"
          data-ng-model="customer.ValidTo"
          data-is-open="toOpened"
          data-min-date="minDate"
          data-datepicker-options="dateOptions"
          data-date-disabled="disabled(date, mode)"
          data-ng-required="false"
          data-close-text="Close" />
        <span class="input-group-btn">
          <button type="button" class="btn btn-default" data-ng-click="toOpen($event)"><i class="glyphicon glyphicon-calendar"></i></button>
        </span>
      </p>
    </div>
  </div>

  <p />
  <div class="row">
    <div class="col-md-3">
      <button class="btn btn-primary" data-ng-show="!editMode" data-ng-click="submit()">Create</button>
      <button class="btn btn-danger" data-ng-show="editMode" data-ng-click="update()">Update</button>
      <button class="btn" data-ng-show="editMode" data-ng-click="cancelUpdate()">Cancel</button>
    </div>
  </div>



  <table class="table table-striped table-hover">
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Valid From</th>
        <th>Valid To</th>
      </tr>
    </thead>
    <tbody>
      <tr data-ng-repeat="c in customerList | filter:{Name:customerFilter}">
        <td>{{c.Name}}</td>
        <td>{{c.CustomerType}}</td>
        <td>{{c.ValidFrom | date:'mediumDate'}}</td>
        <td>{{c.ValidTo | date:'mediumDate'}}</td>
        <td>
          <a href="#" data-ng-click="delete(c.CustomerId)">Remove</a> | 
        <a href="#" data-ng-click="edit(c)">Edit</a>
        </td>

      </tr>
    </tbody>
  </table>


</div>

@section headScript
{

  <link href="~/Content/themes/base/jquery-ui.css" rel="stylesheet" />
}

@section Scripts
{
  <script src="~/Scripts/jquery-ui-1.10.4.min.js"></script>
  <script src="~/Scripts/angular.min.js"></script>
  <script src="~/Scripts/angular-ui.js"></script>

}



@section footScript
{
  <script>

    $(function () {
      $(".dp").datepicker({ dateFormat: 'M d, yy' });
    });


    var app = angular.module("customerApp", ['ui.bootstrap']);
    app.controller("customerCtrl", function ($scope, $http) {
      $scope.customerFilter = "";
      $scope.customer = {};
      $scope.editMode = false;
      $scope.x = "Clara";
      var restUrl = "/api/CustomerApi";
      $scope.submit = function () {
        // console.dir($scope.customer);
        $http({ method: "POST", url: restUrl, data: $scope.customer })
          .success(function (data) {
            //console.log("Success data: " + data);
            $scope.updateList();
            $scope.customer = {};
          }).
        error(function (data) {
          console.log("Error data: " + data);

        });
      }; //End submit


      $scope.customerList = [];
      $scope.updateList = function () {
        $http({ method: "GET", url: restUrl }).
          success(function (data) {
            console.dir(data);
            $scope.customerList = data;
          }).
          error(function (data) { });
      }; //End updateList

      $scope.delete = function (id) {
        //console.log(id);
        $http({ method: "DELETE", url: restUrl + "/" + id }).
          success(function (data) {
            //console.log("dele Success data: " + data);
            $scope.updateList();


          })
          .error(function (data) {
            console.log("dele Error data: " + data);

          });
      }; //end delete

      $scope.edit = function (cust) {
        $scope.customer = cust;
        $scope.editMode = true;
      }; //end edit

      $scope.update = function () {
        //console.dir($scope.customer);
        $http({ method: "PUT", url: restUrl + "/" + $scope.customer.CustomerId, data: $scope.customer }).
          success(function (data) {
            console.log("SUC" + data);
            $scope.editMode = false;
            $scope.updateList();
            $scope.customer = {};

          }).
          error(function (date) { });
      };


      $scope.cancelUpdate = function () {
        $scope.customer = {};
        $scope.editMode = false;
        $scope.updateList();

      };

      $scope.resetSearch = function () {
        // console.log("reset");
        $scope.customerFilter = "";
      };
      $scope.updateList();

      //Date functions

      $scope.fromOpened = false;
      $scope.to = false;

      $scope.fromOpen = function ($event) {
        $event.preventDefault();
        $event.stopPropagation();

        $scope.fromOpened = true;
      };

      $scope.toOpen = function ($event) {
        $event.preventDefault();
        $event.stopPropagation();

        $scope.toOpened = true;
      };

      $scope.dateOptions = {
        formatYear: 'yy',
        startingDay: 1
      };
      $scope.formats = ['dd-MMMM-yyyy', 'yyyy/MM/dd', 'dd.MM.yyyy', 'shortDate', 'mediumDate'];
      $scope.format = $scope.formats[4];
    });
  </script>
}
